MBCNTR2503.Modernizer

## Overview
This project modernizes the legacy MBCNTR2503 COBOL system to .NET, converting EBCDIC packed decimal mortgage billing records to ASCII format while maintaining exact parity with legacy outputs.

## Current Status
- **Stage 1 Container Processing**: âœ… **100% PERFECT PARITY** across all 8 file types for all 4 jobs
  - `.4300`, `.dat.rectype`, `.dat.total`, `.4300.txt`, `.4300.txt.suspect`
  - `.4300.txt.new`, `.4300.txt.length`, `.ncpjax`
- **Stage 2 EBCDICâ†’ASCII**: 99.65-100% parity on D/P records; 99.65-99.74% on S records
- **MB2000 Conversion**: ~72% parity pending client-specific field logic completion
- **Major Fixes Completed**:
  - âœ… LENGTH_MISMATCH pattern (120 errors fixed) - ASCII detection in text fields
  - âœ… ZERO_VARIATIONS pattern (5 errors fixed) - MB-PAYMENT-AMOUNT field mapping corrected
  - âœ… `.4300.txt.length` parity (2025-09-30) - Legacy +1 byte quirk replicated
  - âœ… Field metadata loading path resolved
- **Remaining**: Header window alignment in Stage 2, MB2000 client-specific mappings

## ðŸ“Š Parity Snapshot (2025-09-30)

- **Total Jobs Processed**: 4 (69172, 80147, 80299, 80362)
- **Overall Content Match**: 97.97% (56 files)
- **Stage 1 Container Processing**: ðŸŽ‰ **100% Perfect Parity** (8/8 file types, excluding missing .se1)
- **Primary blockers**: Header windows in `.dat.asc` and `.dat.asc.11.1.s` (per-record offsets `[9â€“10]` and secondary windows `[37â€“121]`, `[129â€“146]`, `[1001â€“1010]`). P/D splits and ancillary files remain â‰¥99.9% aligned.

### Stage 1 Achievements
All Container Step 1 artifacts now achieve **100% byte-for-byte parity**:
- Container files (`.4300`): Perfect across all jobs
- Metadata files (`.dat.rectype`, `.dat.total`): Perfect across all jobs
- Text extraction (`.4300.txt`): Perfect across all jobs
- Validation (`.4300.txt.suspect`): Perfect across all jobs
- Text-binary merge (`.4300.txt.new`, `.4300.txt.length`): Perfect across all jobs (fixed 2025-09-30)
- Key derivation (`.ncpjax`): Perfect across all jobs

### Stage 2 Status

- **69172**: Near-perfect parity (100% on most files)
- **80147**: 99.8% `.dat.asc`, 99.74% `.dat.asc.11.1.s` (header window issues)
- **80299**: 99.77% `.dat.asc`, 99.71% `.dat.asc.11.1.s` (header window issues)
- **80362**: 99.72% `.dat.asc`, 99.65% `.dat.asc.11.1.s` (header window issues)

All `.asc.11.1.d` files are near-perfect (99.93%+); `.asc.11.1.p` / `.asc.11.1.p.keyed` remain â‰¥99.9%. `p.set` parity remains ~72% pending MB2000 override alignment.

> Regenerate the full report with: `python generate_stage_report.py`



















## ðŸ“Š Latest Parity Report

*This report was generated by running `generate_stage_report.py` on 2025-09-30 07:56:04*

### Overall Summary
- **Total Jobs Processed**: 4
- **Total Files Compared**: 56
- **Overall Size Match**: 100.00%
- **Overall Content Match**: 97.97%

### Stage Parity Overview

Stage 1: INITIAL SET UP & CONTAINER PROCESSING (mbcntr2503.script)
```
file name          69172    80147    80299    80362   
*.se1              MISSING-A MISSING-E MISSING-E MISSING-E
*.4300             100%     100%     100%     100%    
*.dat.rectype      100%     100%     100%     100%    
*.dat.total        100%     100%     100%     100%    
*.4300.txt         100%     100%     100%     100%    
*.4300.txt.suspect 100%     100%     100%     100%    
*.4300.txt.new     100%     100%     100%     100%    
*.4300.txt.length  100%     100%     100%     100%    
*.ncpjax           100%     100%     100%     100%    
```

Stage 2: DATA CONVERSION & ASCII PROCESSING (estmb2000.script)
```
file name              69172    80147    80299    80362   
*.dat.asc              100%     99.8%    99.77%   99.72%  
*.dat.asc.11.1.p       100%     100%     99.93%   99.94%  
*.dat.asc.11.1.s       100%     99.74%   99.71%   99.65%  
*.dat.asc.11.1.d       100%     99.93%   99.93%   99.93%  
*.dat.asc.11.1.p.keyed 100%     100%     99.93%   99.74%  
*p.asc                 MISSING-A MISSING-A MISSING-A MISSING-A
*p.set                 72.92%   72.02%   72.06%   72.02%  
*e.asc                 MISSING-E MISSING-E MISSING-A MISSING-A
*e.txt                 MISSING-A MISSING-A MISSING-A MISSING-A
```

---
*To regenerate the stage summary, run: `python generate_stage_report.py`*


## Prerequisites
- .NET 8 SDK (Windows/macOS/Linux)
- Python 3.x for parity checking scripts
- Config files at `config/base/mblps` (mirrors legacy mblps structure)

## Quick Start

### 1. Build the Schema
```bash
dotnet run --project src/Cnp.Cli -- build-schema --schema "config/base/mblps" --out "schemas/compiled"
```
**Output:** `schemas/compiled/<sha>.schema.json` - Compiled schema for pipeline consumption

### 2. Run the Complete Pipeline
```bash
# Recommended: Run the full end-to-end pipeline for a job
dotnet run --project src/Cnp.Cli -- run-pipeline --job 69172 --schema "config/base/mblps" --verbose
```
**This command executes all pipeline stages:**
- Container Step 1 (.4300, .dat.rectype, .dat.total)
- Text extraction (.4300.txt)
- Suspect validation (.4300.txt.suspect)
- Text-binary merge (.4300.txt.new, .4300.txt.length)
- NCPJAX generation (.ncpjax)
- EBCDICâ†’ASCII conversion (.dat.asc, .asc.11.1.[p|s|d])
- Key enrichment (.asc.11.1.p.keyed)
- MB2000 conversion (p.set)

**Alternative: Run individual stages**
```bash
# Stage 1 only (generates .4300, .dat.rectype, .dat.total - does NOT include text merge)
dotnet run --project src/Cnp.Cli -- run-step1 --job 69172 --input "Input/69172.dat" --out "out/69172" --schema "config/base/mblps"

# Text extraction, validation, and merge (complete Stage 1)
dotnet run --project src/Cnp.Cli -- extract-text --job 69172 --input "out/69172/69172.4300" --out "out/69172" --schema "config/base/mblps"
dotnet run --project src/Cnp.Cli -- validate-suspect --job 69172 --input "out/69172/69172.4300.txt" --out "out/69172"
dotnet run --project src/Cnp.Cli -- merge-txt-new --job 69172 --txt-input "out/69172/69172.4300.txt" --binary-input "out/69172/69172.4300" --out "out/69172"

# EBCDICâ†’ASCII conversion
dotnet run --project src/Cnp.Cli -- ebcdic-to-ascii --job 69172 --input "Input/69172.dat" --out "out/69172" --schema "config/base/mblps"

# Key enrichment
dotnet run --project src/Cnp.Cli -- enrich-keys --job 69172 --p-file "out/69172/69172.dat.asc.11.1.p" --s-file "out/69172/69172.dat.asc.11.1.s" --out "out/69172"

# MB2000 conversion
dotnet run --project src/Cnp.Cli -- mb2000-convert --job 69172 --input "out/69172/69172.dat.asc.11.1.p.keyed" --out "out/69172" --schema "config/base/mblps"
```

### 3. Check Parity
```bash
# Generate comprehensive stage-by-stage parity report
python3 generate_stage_report.py

# Or check parity for a specific job
python3 debug-parity.py 69172
```

## Pipeline Architecture

### Core Components
- **src/Cnp.Schema**: Schema compiler and models for DD file processing
- **src/Cnp.Decoders**: Packed/zoned/binary/EBCDIC decoding utilities
- **src/Cnp.Pipeline**: Pipeline orchestrator and processing stages
  - `EbcdicProcessor.cs`: EBCDIC to ASCII conversion, record type processing
  - `MB2000FieldMapper.cs`: Field mapping with override support
- **src/Cnp.Cli**: CLI entrypoint and command handlers

### Data Flow
1. **Input**: Legacy EBCDIC files (`.dat.asc.11.1.p.keyed`)
2. **Processing**: EBCDICâ†’ASCII conversion, field mapping, packed decimal handling
3. **Output**: MB2000 format files (`.set`) with 2000-byte records
4. **Validation**: Parity checking against expected legacy outputs

## Configuration Files

### Schema Definition (`mblps.dd`)
```
Field-Name, Offset, Length, Type, DecimalPlaces
MB-PAYMENT-AMOUNT, 749, 6, Packed Number, 2
MB-FIRST-P-I, 755, 6, Packed Number, 2
```

### Field Overrides (`mb2000.overrides.json`)
```json
{
  "source": "MB-PAYMENT-AMOUNT",
  "target": "MB-PAYMENT-AMOUNT", 
  "sourceOffset": 323,
  "sourceLength": 6,
  "mode": "packed",
  "trimOutput": false
}
```

### Field Metadata (`FieldDefinitions_Generated.json`)
```json
{
  "recordLayouts": {
    "MB_PAYMENT_AMOUNT": {
      "startPosition": 749,
      "length": 6,
      "type": 1,
      "decimalPlaces": 2,
      "description": "Packed Number field"
    }
  }
}
```

## Detailed Usage Guide

### Running the Pipeline

#### Step 1: Build Schema
```bash
# Compile DD files into JSON schema
dotnet run --project src/Cnp.Cli -- build-schema --schema "config/base/mblps" --out "schemas/compiled"
```

#### Step 2: Execute Pipeline
```bash
# Run modernization pipeline for a specific job
dotnet "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/src/Cnp.Cli/bin/Debug/net8.0/Cnp.Cli.dll" run-pipeline \
  --job 69172 \
  --schema "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/config/base/mblps" \
  --verbose
```

**Input Files Expected:**
- `Legacy Application/Expected_Outputs/69172/69172.dat.asc.11.1.p.keyed`

**Output Files Generated:**
- `out/69172/69172p.set` (2000-byte MB2000 records)
- `out/69172/mb2000_69172.log` (processing log)

### Parity Checking

#### Basic Parity Check
```bash
python3 debug-parity.py 69172
```

#### Understanding Parity Output
```
--- Summary ---
Found 1150 total field differences across all records.

Common Error Patterns:
- LENGTH_MISMATCH: Field length discrepancies
- ZERO_VARIATIONS: Zero value encoding issues  
- QUESTION_MARKS: Character encoding problems
- PACKED_DECIMAL_CONVERSION: Packed decimal format issues
```

#### Advanced Parity Analysis
```bash
# Generate detailed field-by-field comparison
python3 debug-parity.py 69172 > parity_detailed.log

# Analyze specific error patterns
python3 advanced_pattern_analyzer.py
```

### JSON Schema Parsing

#### Schema Structure
The compiled schema (`schemas/compiled/<sha>.schema.json`) contains:

```json
{
  "title": "MB2000 Output Record",
  "type": "object", 
  "properties": {
    "MB-PAYMENT-AMOUNT": {
      "type": "string",
      "maxLength": 11,
      "description": "Payment amount field",
      "x-offset": 749,
      "x-length": 6,
      "x-scale": 2,
      "x-type": "PackedDecimal"
    }
  }
}
```

#### Field Metadata Loading
The `MB2000FieldMapper.cs` loads field definitions from `FieldDefinitions_Generated.json`:

```csharp
private static Dictionary<string, FieldMetadata> LoadFieldMetadata()
{
    // Tries multiple paths to find FieldDefinitions_Generated.json
    var possiblePaths = new[]
    {
        "/Users/vshanmu/3OSG/FieldDefinitions_Generated.json",
        Path.Combine(currentDir, "..", "..", "FieldDefinitions_Generated.json"),
        Path.Combine(currentDir, "FieldDefinitions_Generated.json")
    };
}
```

#### Override Processing
Field overrides in `mb2000.overrides.json` support multiple modes:

- **`packed`**: Packed decimal (COMP-3) conversion
- **`copyTrim`**: Direct copy with trimming
- **`zonedDecimal`**: Zoned decimal conversion
- **`ebcdic_spaces`**: Fill with EBCDIC spaces (0x40)

### Complete End-to-End Workflow

#### 1. Initial Setup
```bash
# Generate field definitions from DD file
python3 regenerate_field_definitions.py

# Bootstrap overrides from compiled schema
dotnet run --project src/Cnp.Cli -- bootstrap-overrides-from-compiled \
  --schema config/base/mblps \
  --out config/base/mblps/mb2000.overrides.json
```

#### 2. Schema Compilation
```bash
# Build compiled schema for pipeline
dotnet run --project src/Cnp.Cli -- build-schema \
  --schema config/base/mblps \
  --out schemas/compiled
```

#### 3. Pipeline Execution
```bash
# Process specific job
dotnet "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/src/Cnp.Cli/bin/Debug/net8.0/Cnp.Cli.dll" run-pipeline \
  --job 69172 \
  --schema "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/config/base/mblps" \
  --verbose
```

#### 4. Validation & Debugging
```bash
# Check parity
python3 debug-parity.py 69172

# Analyze patterns (if errors found)
python3 advanced_pattern_analyzer.py
python3 zero_variations_analyzer.py
```

## Troubleshooting

### Common Issues

#### Pipeline Fails with "FieldDefinitions_Generated.json not found"
```bash
# Regenerate field definitions
python3 regenerate_field_definitions.py
```

#### Parity Check Shows High Error Count
1. Check field offsets in `mb2000.overrides.json`
2. Verify packed decimal field definitions
3. Analyze error patterns with debugging scripts

#### Packed Decimal Conversion Issues
- Ensure `sourceOffset` and `sourceLength` match DD file
- Verify `decimalPlaces` in `FieldDefinitions_Generated.json`
- Check for EBCDIC vs ASCII source data

---

## Key Technical Insights

### Field Mapping Corrections
- **MB-PAYMENT-AMOUNT**: Fixed offset from 749 to 323, length from 1 to 6 bytes
  - Source: `MB1100-TOT-PYMT` from `mb1500.dd` (total payment calculation)
  - Format: `S9(9)V99 COMP-3` (6-byte packed decimal with 2 decimal places)
- **FieldDefinitions_Generated.json**: Corrected loading path resolution for runtime field metadata

### Data Conversion Issues Resolved
- **ASCII Detection**: Implemented smart detection for text fields already in ASCII format
- **Packed Decimal Handling**: Raw copy for P-records, proper encoding for MB2000 output
- **EBCDIC vs ASCII**: Fixed parity script to decode MB2000 output as ASCII, not EBCDIC

### Debugging Methodology
1. **Pattern Analysis**: Categorized errors by type (LENGTH_MISMATCH, ZERO_VARIATIONS, etc.)
2. **Legacy Code Analysis**: Traced data flow through COBOL programs (`setmb2000.cbl`, `mb1500.dd`)
3. **Systematic Offset Correction**: Used hexdump analysis to find correct field positions
4. **Incremental Testing**: Fixed one pattern at a time with immediate parity validation

---

# Useful Commands (Recommended)
  ```bash
  # Build JSON schema from DD and IO map
  dotnet run --project src/Cnp.Cli -- build-schema --schema config/base/mblps --out schemas/compiled
  
  # Bootstrap overrides from compiled schema (preferred)
  dotnet run --project src/Cnp.Cli -- bootstrap-overrides-from-compiled \
    --schema config/base/mblps \
    --out config/base/mblps/mb2000.overrides.json
  
  # Initial skeleton overrides (deprecated)
  #  dotnet run --project src/Cnp.Cli -- init-overrides --template schemas/source/mb2000.output.schema.json --schema config/base/mblps --out overrides.template.json
  ```



## End-to-End Pipeline Flow (Legacy vs C#)

The modernization reproduces the legacy monthly bill run in distinct stages. This section documents the end-to-end flow and shows which modern C# component corresponds to each legacy script/program and what artifact it produces. Use this as the authoritative reference for coverage and gaps.

### 1) Container Step 1 (normalize container and derive diagnostics)
- **Legacy**: `ncpcntr5v2.script` and related tools
- **Inputs**: `<job>.dat`
- **Outputs**: `<job>.4300`, `<job>.dat.rectype`, `<job>.dat.total`, `<job>.4300.txt`, `<job>.4300.txt.suspect`, `<job>.4300.txt.new`, `<job>.4300.txt.length`, `<job>.ncpjax`
- **Modern C#**:
  - `Cnp.Pipeline.Step1Orchestrator` â†’ `.4300`, `.dat.rectype`, `.dat.total`
  - `Cnp.Pipeline.TextExtractor` â†’ `.4300.txt`
  - `Cnp.Pipeline.SuspectValidator` â†’ `.4300.txt.suspect`
  - `Cnp.Pipeline.TxtNewMerger` â†’ `.4300.txt.new`, `.4300.txt.length`
  - `Cnp.Pipeline.NcpjaxGenerator` â†’ `.ncpjax`
- **Status**: 100% perfect parity across all four jobs (see Job Status Details above)

### 2) EBCDIC â†’ ASCII conversion and record split
- **Legacy**: `setmb2000.script` â†’ `mbcnvt0.out` then `ncpsplitall.out`
- **Inputs**: `<job>.dat`
- **Outputs**: `<job>.dat.asc`, `<job>.dat.asc.11.1.p`, `<job>.dat.asc.11.1.s`, `<job>.dat.asc.11.1.d`
- **Modern C#**: `Cnp.Pipeline.EbcdicProcessor.ProcessDatToAsc`
- **Configuration**: DD/IOMAP under `config/base/mblps` (no hardcoding); schema compiled via `Cnp.Schema`
- **Status (parity)**: `.dat.asc ~64â€“65%`, `.asc.11.1.d ~99.9%`, `.asc.11.1.p ~99.9%`, `.asc.11.1.s ~53%` (varies per job; see report)

### 3) Key enrichment (add keys to P/S records)
- **Legacy**: `cnpfilekeys.out`
- **Inputs**: `<job>.dat.asc.11.1.p`, `<job>.dat.asc.11.1.s`
- **Outputs**: `<job>.dat.asc.11.1.p.keyed`
- **Modern C#**: `Cnp.Pipeline.KeyEnrichmentProcessor`
- **Status (parity)**: ~99.65â€“99.72% match across jobs

### 4) MB2000 conversion (1500-byte P â†’ 2000-byte MB2000 record)
- **Legacy**: `setmb2000.out` (driven by `setmb2000.script`), with client-specific branches in `setmb2000.cbl`
- **Inputs**: `<job>p.asc`/`<job>.dat.asc.11.1.p.keyed`
- **Outputs**: `<job>p.set` (2000 bytes/record)
- **Modern C#**: `Cnp.Pipeline.MB2000FieldMapper` (client-aware) + overrides from `config/base/mblps/mb2000.overrides.json` and optional `mb2000.overrides.<client>.json`
- **Status (parity)**: ~71â€“73% content match; client-specific field logic still being ported

### 5) E-bill split and post-processing
- **Legacy**: `cnpsplit4.out` to separate E vs P accounts, with renames to `e.asc`, `p.asc`, `e.txt`
- **Modern C#**: Not yet implemented (planned). To be expressed as `IEbillSelector` strategy and file writers.

### 6) Grouping, tagging, counts, samples, remit artifacts
- **Legacy**: `ncpcntr0v2.script`, `tagit10.script`, remote GMC pass, `cnpautocount.out`, `ncpcntrsample0.out`
- **Outputs**: `*p.cntr.wrk`, `*p.cntr.grp`, `*e.cntr.grp`, `.total`, `.sample`, `.remit3`, `.count.auto`, aggregated `.all.grp`
- **Modern C#**: Not yet implemented (planned). Will be modeled as additional pipeline stages with deterministic writers.

### 7) Mail tracking containers
- **Legacy**: `cntrimbremit.script`, `cnpimbremit1.script`
- **Modern C#**: Out of current scope.


## Legacy â†” C# Implementation Mapping

| Stage | Legacy component (script/program) | Primary outputs | Modern C# counterpart | Config/Overrides | Coverage/Status |
|------|------------------------------------|------------------|-----------------------|------------------|-----------------|
| Container Step 1 | `ncpcntr5v2.script` (+ helpers) | `.4300`, `.dat.rectype`, `.dat.total` | `Step1Orchestrator` | `config/base/mblps` DD/IOMAP | 100% perfect parity |
| Text extraction | Part of Step 1 flow | `.4300.txt` | `TextExtractor` | Compiled schema fields | 100% perfect parity |
| Suspect validation | Part of Step 1 flow | `.4300.txt.suspect` | `SuspectValidator` | ASCII/EBCDIC rules from schema | 100% perfect parity |
| Text merge/length | Part of Step 1 flow | `.4300.txt.new`, `.4300.txt.length` | `TxtNewMerger` | Schema-driven | 100% perfect parity |
| Key derivation | `ddcontrol` parsing path | `.ncpjax` | `NcpjaxGenerator` | `config/base/mblps/ddcontrol*` | 100% perfect parity |
| EBCDICâ†’ASCII | `mbcnvt0.out` | `.dat.asc` | `EbcdicProcessor` | Schema-driven field types | ~64â€“65% match |
| Record split | `ncpsplitall.out` | `.asc.11.1.p/s/d` | `EbcdicProcessor` (split) | Schema record types | d/p ~99.9%, s ~53% |
| Key enrichment | `cnpfilekeys.out` | `.asc.11.1.p.keyed` | `KeyEnrichmentProcessor` | Fixed record specs | ~99.65â€“99.72% |
| MB2000 convert | `setmb2000.out` + `setmb2000.cbl` | `<job>p.set` | `MB2000FieldMapper` | `mb2000.overrides*.json` | ~71â€“73% |
| Eâ€‘bill split | `cnpsplit4.out` | `e.asc`, `e.txt`, `p.asc` | Planned `IEbillSelector` + writers | Externalized rules | Not implemented |
| Grouping/rollups | `ncpcntr0v2.script`, `tagit10.script`, GMC | `*cntr.grp*`, `.total`, `.sample`, `.remit3`, `.count.auto`, `.all.grp` | Planned pipeline stages | To be modeled | Not implemented |
| Mail tracking | `cntrimbremit.script`, `cnpimbremit1.script` | Mail tracking containers | Out of scope | N/A | Not in scope |

Notes:
- All field positions/types come from compiled schema produced from `config/base/mblps` inputs. Client-specific behavior must be captured via override files â€” no hardcoding.
- Client-aware overrides: the orchestrator prefers `mb2000.overrides.<client>.json` over the base `mb2000.overrides.json` when present.


## Coverage, Gaps, and Next Actions

- **Covered (parity achieved):**
  - Container Step 1: `.4300`, `.dat.rectype`, `.dat.total`, `.4300.txt`, `.4300.txt.suspect`, `.4300.txt.new`, `.4300.txt.length`, `.ncpjax`

- **Partially covered (needs work):**
  - EBCDICâ†’ASCII and split: Improve `.dat.asc` and `.asc.11.1.s` fidelity (see per-job stats). Validate text vs numeric conversions near mixed zones and packed windows.
  - Key enrichment: Minor residual diffs; re-check formatting and key composition edge cases.
  - MB2000 conversion: Port client-specific logic from `setmb2000.cbl` into configuration-driven transformers and finalize mappings in `mb2000.overrides*.json`.

- **Not yet covered (planned):**
  - Eâ€‘bill split (`cnpsplit4.out` equivalence) and renames (`e.asc`, `e.txt`, `p.asc`).
  - Grouping/rollups (`*cntr.grp*`, `.total`, `.sample`, `.remit3`, `.count.auto`, `.all.grp`).
  - Mail tracking container generation.

- **Immediate next actions (no hardcoding; use overrides):**
  - Externalize and validate Sâ€‘record conversion nuances in `EbcdicProcessor` using schema metadata; add targeted tests for the 53% Sâ€‘record gap.
  - Complete client-aware mapping rules for MB2000 in `mb2000.overrides.json` and `mb2000.overrides.<client>.json`; implement customer transformers aligned to `setmb2000.cbl` branches (e.g., `BUILD-0503-FIELDS`).
  - Tighten key enrichment parity by verifying field offsets, zeroâ€‘fill, and counter formatting.
  - Design and implement `IEbillSelector` strategy + writers to reproduce `cnpsplit4.out` behavior using configuration.
  - Model grouping/tagging/count/sample/remit as deterministic stages with schema-driven parameters.

### Header Window Remediation Plan

- Extend `TxtNewMerger` so it walks every `.4300.txt` block (D/P/S/â€¦) and preserves the exact legacy prefixes (e.g., `503|`) while merging trailing client windows. Resulting `.4300.txt.new` files match `ncpcntr5` byte-for-byte.
- Introduce an override-driven cache inside `EbcdicProcessor` that loads the generated `.4300` artifacts for the current job. No hardcoded offsetsâ€”window definitions live in `ebcdic.overrides.json` / client overrides.
- During record normalization the processor copies the cached ASCII segments into windows `[37..121]`, `[129..146]`, and `[1005..1010]` before running IBM037 conversion, then executes the existing normalization/override logic.
- Re-run parity for jobs `80147`, `80299`, `80362` to confirm the remediation closes outstanding diffs. Once parity is clean, document the window mappings in `Parity-Issue-Snapshot.md` and roll the README snapshot forward.

Crossâ€‘references for developers:
- Detailed design: `MBCNTR2503.CSharpDesign.md`
- Field metadata: `FieldDefinitions_Generated.json`
- Overrides: `config/base/mblps/mb2000.overrides.json` (+ client-specific variants)
- CLI entry: `src/Cnp.Cli` (`run-pipeline`, `build-schema`, and related commands)

### TODO (Permanent fixes replacing overrides)

- Replace `deltaAfterIBM037` offset rules with proper field-mode handling in `EbcdicProcessor`:
  - Ensure windows currently differing (e.g., per-record positions 9â€“11 and 1509â€“1511 in `.asc.11.1.s`, and small D/P windows) are decoded with Standard(IBM037) where appropriate instead of raw copies.
  - Keep zoned-decimal blank handling for S records in code (blank EBCDIC â†’ ASCII spaces) and remove equivalent overrides.
  - Align memmove/post-processing ordering to legacy so spacing/byte-kind matches without deltas.
- Implement real `IsLoanFieldPacked()` in `EbcdicProcessor` (reuse Step1 logic) and stop relying on placeholder behavior.
- After parity proves stable across all jobs, delete narrow `deltaAfterIBM037` rules from `config/base/mblps/ebcdic.overrides.json`.
