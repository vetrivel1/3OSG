MBCNTR2503.Modernizer

## Overview
This project modernizes the legacy MBCNTR2503 COBOL system to .NET, converting EBCDIC packed decimal mortgage billing records to ASCII format while maintaining exact parity with legacy outputs.

## Current Status
- **Parity Achievement**: 11.2% improvement (145 errors eliminated from ~1295 total)
- **Major Fixes Completed**:
  - ‚úÖ LENGTH_MISMATCH pattern (120 errors fixed) - ASCII detection in text fields
  - ‚úÖ ZERO_VARIATIONS pattern (5 errors fixed) - MB-PAYMENT-AMOUNT field mapping corrected
  - ‚úÖ Field metadata loading path resolved
- **Remaining**: ~1150 field differences across all records

## üìä Latest Parity Report

*This report was generated by running `generate_report.py` on 2025-09-29 06:37:20*

### Overall Summary
- **Total Jobs Processed**: 1
- **Total Files Compared**: 14
- **Overall Size Match**: 99.28%
- **Overall Content Match**: 89.54%

### Job Status Details

| Job ID | Files | Size Match % | Content Match % | Status |
|--------|-------|--------------|-----------------|--------|
| 69172 | 14 | 99.28% | 89.54% | üü¢ GOOD |

### File-by-File Details

#### Job 69172
- **Files Compared**: 14/14
- **Size Match**: 99.28%
- **Content Match**: 89.54%
- **Status**: üü¢ GOOD

**File Details:**
- ‚úÖ `69172.4300` - [OK] Perfect Match
- ‚úÖ `69172.4300.txt` - [OK] Perfect Match
- ‚úÖ `69172.4300.txt.length` - [OK] Perfect Match
- ‚ùå `69172.4300.txt.new` - [NOT OK] Size & Content (99.95%/81.49%)
- ‚úÖ `69172.4300.txt.suspect` - [OK] Perfect Match
- ‚ùå `69172.dat.asc` - [NOT OK] Content (66.44%)
- ‚úÖ `69172.dat.asc.11.1.d` - [OK] Perfect Match
- ‚ùå `69172.dat.asc.11.1.p` - [NOT OK] Content (99.87%)
- ‚ùå `69172.dat.asc.11.1.p.keyed` - [NOT OK] Content (99.72%)
- ‚ùå `69172.dat.asc.11.1.s` - [NOT OK] Content (53.07%)
- ‚úÖ `69172.dat.rectype` - [OK] Perfect Match
- ‚úÖ `69172.dat.total` - [OK] Perfect Match
- ‚ùå `69172.ncpjax` - [NOT OK] Size & Content (90.00%/80.00%)
- ‚ùå `69172p.set` - [NOT OK] Content (72.95%)


---
*To regenerate this report, run: `python generate_report.py`*


## Prerequisites
- .NET 8 SDK (Windows/macOS/Linux)
- Python 3.x for parity checking scripts
- Config files at `config/base/mblps` (mirrors legacy mblps structure)

## Quick Start

### 1. Build the Schema
```bash
dotnet run --project src/Cnp.Cli -- build-schema --schema "config/base/mblps" --out "schemas/compiled"
```
**Output:** `schemas/compiled/<sha>.schema.json` - Compiled schema for pipeline consumption

### 2. Run the Pipeline
```bash
dotnet "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/src/Cnp.Cli/bin/Debug/net8.0/Cnp.Cli.dll" run-pipeline --job 69172 --schema "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/config/base/mblps" --verbose
```

### 3. Check Parity
```bash
python3 debug-parity.py 69172
```

## Pipeline Architecture

### Core Components
- **src/Cnp.Schema**: Schema compiler and models for DD file processing
- **src/Cnp.Decoders**: Packed/zoned/binary/EBCDIC decoding utilities
- **src/Cnp.Pipeline**: Pipeline orchestrator and processing stages
  - `EbcdicProcessor.cs`: EBCDIC to ASCII conversion, record type processing
  - `MB2000FieldMapper.cs`: Field mapping with override support
- **src/Cnp.Cli**: CLI entrypoint and command handlers

### Data Flow
1. **Input**: Legacy EBCDIC files (`.dat.asc.11.1.p.keyed`)
2. **Processing**: EBCDIC‚ÜíASCII conversion, field mapping, packed decimal handling
3. **Output**: MB2000 format files (`.set`) with 2000-byte records
4. **Validation**: Parity checking against expected legacy outputs

## Configuration Files

### Schema Definition (`mblps.dd`)
```
Field-Name, Offset, Length, Type, DecimalPlaces
MB-PAYMENT-AMOUNT, 749, 6, Packed Number, 2
MB-FIRST-P-I, 755, 6, Packed Number, 2
```

### Field Overrides (`mb2000.overrides.json`)
```json
{
  "source": "MB-PAYMENT-AMOUNT",
  "target": "MB-PAYMENT-AMOUNT", 
  "sourceOffset": 323,
  "sourceLength": 6,
  "mode": "packed",
  "trimOutput": false
}
```

### Field Metadata (`FieldDefinitions_Generated.json`)
```json
{
  "recordLayouts": {
    "MB_PAYMENT_AMOUNT": {
      "startPosition": 749,
      "length": 6,
      "type": 1,
      "decimalPlaces": 2,
      "description": "Packed Number field"
    }
  }
}
```

## Detailed Usage Guide

### Running the Pipeline

#### Step 1: Build Schema
```bash
# Compile DD files into JSON schema
dotnet run --project src/Cnp.Cli -- build-schema --schema "config/base/mblps" --out "schemas/compiled"
```

#### Step 2: Execute Pipeline
```bash
# Run modernization pipeline for a specific job
dotnet "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/src/Cnp.Cli/bin/Debug/net8.0/Cnp.Cli.dll" run-pipeline \
  --job 69172 \
  --schema "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/config/base/mblps" \
  --verbose
```

**Input Files Expected:**
- `Legacy Application/Expected_Outputs/69172/69172.dat.asc.11.1.p.keyed`

**Output Files Generated:**
- `out/69172/69172p.set` (2000-byte MB2000 records)
- `out/69172/mb2000_69172.log` (processing log)

### Parity Checking

#### Basic Parity Check
```bash
python3 debug-parity.py 69172
```

#### Understanding Parity Output
```
--- Summary ---
Found 1150 total field differences across all records.

Common Error Patterns:
- LENGTH_MISMATCH: Field length discrepancies
- ZERO_VARIATIONS: Zero value encoding issues  
- QUESTION_MARKS: Character encoding problems
- PACKED_DECIMAL_CONVERSION: Packed decimal format issues
```

#### Advanced Parity Analysis
```bash
# Generate detailed field-by-field comparison
python3 debug-parity.py 69172 > parity_detailed.log

# Analyze specific error patterns
python3 advanced_pattern_analyzer.py
```

### JSON Schema Parsing

#### Schema Structure
The compiled schema (`schemas/compiled/<sha>.schema.json`) contains:

```json
{
  "title": "MB2000 Output Record",
  "type": "object", 
  "properties": {
    "MB-PAYMENT-AMOUNT": {
      "type": "string",
      "maxLength": 11,
      "description": "Payment amount field",
      "x-offset": 749,
      "x-length": 6,
      "x-scale": 2,
      "x-type": "PackedDecimal"
    }
  }
}
```

#### Field Metadata Loading
The `MB2000FieldMapper.cs` loads field definitions from `FieldDefinitions_Generated.json`:

```csharp
private static Dictionary<string, FieldMetadata> LoadFieldMetadata()
{
    // Tries multiple paths to find FieldDefinitions_Generated.json
    var possiblePaths = new[]
    {
        "/Users/vshanmu/3OSG/FieldDefinitions_Generated.json",
        Path.Combine(currentDir, "..", "..", "FieldDefinitions_Generated.json"),
        Path.Combine(currentDir, "FieldDefinitions_Generated.json")
    };
}
```

#### Override Processing
Field overrides in `mb2000.overrides.json` support multiple modes:

- **`packed`**: Packed decimal (COMP-3) conversion
- **`copyTrim`**: Direct copy with trimming
- **`zonedDecimal`**: Zoned decimal conversion
- **`ebcdic_spaces`**: Fill with EBCDIC spaces (0x40)

### Complete End-to-End Workflow

#### 1. Initial Setup
```bash
# Generate field definitions from DD file
python3 regenerate_field_definitions.py

# Bootstrap overrides from compiled schema
dotnet run --project src/Cnp.Cli -- bootstrap-overrides-from-compiled \
  --schema config/base/mblps \
  --out config/base/mblps/mb2000.overrides.json
```

#### 2. Schema Compilation
```bash
# Build compiled schema for pipeline
dotnet run --project src/Cnp.Cli -- build-schema \
  --schema config/base/mblps \
  --out schemas/compiled
```

#### 3. Pipeline Execution
```bash
# Process specific job
dotnet "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/src/Cnp.Cli/bin/Debug/net8.0/Cnp.Cli.dll" run-pipeline \
  --job 69172 \
  --schema "/Users/vshanmu/3OSG/MBCNTR2503.Modernizer/config/base/mblps" \
  --verbose
```

#### 4. Validation & Debugging
```bash
# Check parity
python3 debug-parity.py 69172

# Analyze patterns (if errors found)
python3 advanced_pattern_analyzer.py
python3 zero_variations_analyzer.py
```

## Troubleshooting

### Common Issues

#### Pipeline Fails with "FieldDefinitions_Generated.json not found"
```bash
# Regenerate field definitions
python3 regenerate_field_definitions.py
```

#### Parity Check Shows High Error Count
1. Check field offsets in `mb2000.overrides.json`
2. Verify packed decimal field definitions
3. Analyze error patterns with debugging scripts

#### Packed Decimal Conversion Issues
- Ensure `sourceOffset` and `sourceLength` match DD file
- Verify `decimalPlaces` in `FieldDefinitions_Generated.json`
- Check for EBCDIC vs ASCII source data

---

## Key Technical Insights

### Field Mapping Corrections
- **MB-PAYMENT-AMOUNT**: Fixed offset from 749 to 323, length from 1 to 6 bytes
  - Source: `MB1100-TOT-PYMT` from `mb1500.dd` (total payment calculation)
  - Format: `S9(9)V99 COMP-3` (6-byte packed decimal with 2 decimal places)
- **FieldDefinitions_Generated.json**: Corrected loading path resolution for runtime field metadata

### Data Conversion Issues Resolved
- **ASCII Detection**: Implemented smart detection for text fields already in ASCII format
- **Packed Decimal Handling**: Raw copy for P-records, proper encoding for MB2000 output
- **EBCDIC vs ASCII**: Fixed parity script to decode MB2000 output as ASCII, not EBCDIC

### Debugging Methodology
1. **Pattern Analysis**: Categorized errors by type (LENGTH_MISMATCH, ZERO_VARIATIONS, etc.)
2. **Legacy Code Analysis**: Traced data flow through COBOL programs (`setmb2000.cbl`, `mb1500.dd`)
3. **Systematic Offset Correction**: Used hexdump analysis to find correct field positions
4. **Incremental Testing**: Fixed one pattern at a time with immediate parity validation

---

# Useful Commands (Recommended)
  ```bash
  # Build JSON schema from DD and IO map
  dotnet run --project src/Cnp.Cli -- build-schema --schema config/base/mblps --out schemas/compiled
  
  # Bootstrap overrides from compiled schema (preferred)
  dotnet run --project src/Cnp.Cli -- bootstrap-overrides-from-compiled \
    --schema config/base/mblps \
    --out config/base/mblps/mb2000.overrides.json
  
  # Initial skeleton overrides (deprecated)
  #  dotnet run --project src/Cnp.Cli -- init-overrides --template schemas/source/mb2000.output.schema.json --schema config/base/mblps --out overrides.template.json
  ```


